<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乜都得卡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .stamp-card {
            aspect-ratio: 1.58 / 1; /* Standard card ratio */
        }
        .tick-animation {
            animation: zoomIn 0.3s ease-out forwards;
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 p-4 md:p-8">

    <div class="max-w-2xl mx-auto flex flex-col items-center">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900 mb-2">乜都得卡</h1>
            <p class="text-slate-500">點擊下方藍色圈圈即可蓋章，記錄會自動儲存。</p>
        </header>

        <!-- Main Card Area -->
        <div id="cardContainer" class="stamp-card relative w-full bg-white rounded-2xl shadow-2xl overflow-hidden border border-slate-200 transition-all">
            
            <!-- Background Image -->
            <div id="bgOverlay" class="absolute inset-0 z-0 bg-cover bg-center opacity-90 transition-opacity"></div>
            
            <!-- Default Gradient (visible if no image) -->
            <div id="defaultBg" class="absolute inset-0 z-0 bg-gradient-to-br from-blue-50 to-indigo-100 opacity-50"></div>

            <!-- Stamps Container (Positioned at bottom) -->
            <div class="absolute inset-0 z-10 p-6 flex flex-col justify-end">
                <div id="stampGrid" class="grid grid-cols-5 gap-4 mb-4 justify-items-center">
                    <!-- Stamps generated by JS -->
                </div>
            </div>
        </div>

        <!-- Controls Area -->
        <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
            <!-- Management -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-semibold mb-3 flex items-center gap-2 text-slate-700">
                    <i data-lucide="settings-2" class="w-4 h-4"></i> 管理進度
                </h3>
                <button id="btnRemoveLast" class="w-full bg-yellow-50 hover:bg-yellow-100 text-yellow-700 py-3 rounded-lg font-medium border border-yellow-200 transition-colors flex items-center justify-center gap-2">
                    移除最後一個勾
                </button>
                <p class="text-xs text-slate-400 mt-3">提示：直接點擊已蓋章的圈圈也可以單獨移除。</p>
            </div>

            <!-- Settings -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-semibold mb-3 flex items-center gap-2 text-slate-700">
                    <i data-lucide="image" class="w-4 h-4"></i> 卡片設定
                </h3>
                <label class="w-full bg-slate-50 hover:bg-slate-100 text-slate-600 py-3 rounded-lg font-medium border border-slate-200 transition-colors flex items-center justify-center gap-2 cursor-pointer mb-3">
                    <i data-lucide="upload" class="w-4 h-4"></i> 上傳背景圖片
                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                </label>
                <div class="flex items-center justify-between">
                    <span class="text-xs text-slate-500 font-medium">格子數量:</span>
                    <div class="flex gap-2">
                        <button onclick="updateGrid(10)" class="px-3 py-1 text-xs rounded border bg-blue-50 border-blue-200">10格</button>
                        <button onclick="updateGrid(15)" class="px-3 py-1 text-xs rounded border bg-white border-slate-200">15格</button>
                        <button onclick="updateGrid(20)" class="px-3 py-1 text-xs rounded border bg-white border-slate-200">20格</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 text-slate-400 text-xs text-center">
            進度已加密並自動儲存至雲端
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Setup
       <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  const firebaseConfig = {
    apiKey: "AIzaSyCT-ZuIDrI66NTZ0ZEipDmpfFxbEZrmGto",
    authDomain: "card-5d320.firebaseapp.com",
    projectId: "card-5d320",
    storageBucket: "card-5d320.firebasestorage.app",
    messagingSenderId: "149511398240",
    appId: "1:149511398240:web:c381f874603c51fb74f405",
    measurementId: "G-5FGC2VMT5J"
  };


        let currentUser = null;
        let stamps = Array(10).fill(false);
        let gridCount = 10;

        // Initialize Icons
        lucide.createIcons();

        // UI Elements
        const stampGrid = document.getElementById('stampGrid');
        const bgOverlay = document.getElementById('bgOverlay');
        const defaultBg = document.getElementById('defaultBg');
        const imageUpload = document.getElementById('imageUpload');
        const btnRemoveLast = document.getElementById('btnRemoveLast');

        // Auth Logic
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                subscribeToData();
            }
        });

        // Firestore Logic
        function subscribeToData() {
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'card_data', 'current');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    stamps = data.stamps || Array(10).fill(false);
                    gridCount = stamps.length;
                    renderStamps();
                } else {
                    saveToCloud();
                }
            }, (err) => console.error("Firestore Error:", err));
        }

        async function saveToCloud() {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'card_data', 'current');
            await setDoc(docRef, { 
                stamps: stamps,
                updatedAt: new Date()
            }, { merge: true });
        }

        // Rendering Logic
        function renderStamps() {
            stampGrid.innerHTML = '';
            // Update grid columns based on count
            const cols = gridCount > 10 ? 5 : 5; 
            stampGrid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;

            stamps.forEach((isTicked, index) => {
                const btn = document.createElement('button');
                btn.className = `relative w-12 h-12 md:w-16 md:h-16 rounded-full border-4 flex items-center justify-center transition-all transform active:scale-95 shadow-sm backdrop-blur-sm ${
                    isTicked 
                    ? 'bg-green-50 border-green-500 shadow-green-100' 
                    : 'bg-white/80 border-blue-400 hover:border-blue-500'
                }`;
                
                if (isTicked) {
                    btn.innerHTML = `<i data-lucide="check" class="text-green-600 w-8 h-8 stroke-[3] tick-animation"></i>`;
                } else {
                    btn.innerHTML = `<div class="w-2 h-2 rounded-full bg-blue-200"></div>`;
                }

                btn.onclick = () => {
                    stamps[index] = !stamps[index];
                    renderStamps();
                    saveToCloud();
                };

                stampGrid.appendChild(btn);
            });
            lucide.createIcons();
        }

        // Global functions for grid update
        window.updateGrid = (count) => {
            if (count > stamps.length) {
                stamps = [...stamps, ...Array(count - stamps.length).fill(false)];
            } else {
                stamps = stamps.slice(0, count);
            }
            gridCount = count;
            renderStamps();
            saveToCloud();
        };

        // Event Listeners
        btnRemoveLast.onclick = () => {
            const lastIndex = stamps.lastIndexOf(true);
            if (lastIndex !== -1) {
                stamps[lastIndex] = false;
                renderStamps();
                saveToCloud();
            }
        };

        imageUpload.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    bgOverlay.style.backgroundImage = `url(${event.target.result})`;
                    defaultBg.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        };

        // Start
        initAuth();
        renderStamps();

    </script>
</body>
</html>
