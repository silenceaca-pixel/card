<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乜都得卡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .stamp-card { aspect-ratio: 1.58 / 1; min-height: 250px; }
        .tick-animation { animation: zoomIn 0.3s ease-out forwards; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 p-4 md:p-8">

    <div class="max-w-2xl mx-auto flex flex-col items-center">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900 mb-2">乜都得卡</h1>
            <p id="status" class="text-slate-500 text-sm">正在連線至雲端...</p>
        </header>

        <div id="cardContainer" class="stamp-card relative w-full bg-white rounded-2xl shadow-2xl overflow-hidden border border-slate-200">
            <div id="bgOverlay" class="absolute inset-0 z-0 bg-cover bg-center opacity-90 transition-opacity"></div>
            <div id="defaultBg" class="absolute inset-0 z-0 bg-gradient-to-br from-blue-50 to-indigo-100 opacity-50"></div>
            <div class="absolute inset-0 z-10 p-6 flex flex-col justify-end">
                <div id="stampGrid" class="grid grid-cols-5 gap-3 md:gap-4 mb-4 justify-items-center"></div>
            </div>
        </div>

        <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
            <!-- 管理進度 -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-semibold mb-3 flex items-center gap-2 text-slate-700">
                    <i data-lucide="settings-2" class="w-4 h-4"></i> 管理進度
                </h3>
                <button id="btnRemoveLast" class="w-full bg-yellow-50 hover:bg-yellow-100 text-yellow-700 py-3 rounded-lg font-medium border border-yellow-200 transition-colors mb-3">
                    移除最後一個勾
                </button>
                <div class="flex items-center justify-between">
                    <span class="text-xs text-slate-500 font-medium">格子數量:</span>
                    <div id="gridControls" class="flex gap-2">
                        <button onclick="changeGridSize(10)" class="grid-btn px-3 py-1 text-xs rounded border bg-white border-slate-200" data-size="10">10格</button>
                        <button onclick="changeGridSize(15)" class="grid-btn px-3 py-1 text-xs rounded border bg-white border-slate-200" data-size="15">15格</button>
                        <button onclick="changeGridSize(20)" class="grid-btn px-3 py-1 text-xs rounded border bg-white border-slate-200" data-size="20">20格</button>
                    </div>
                </div>
            </div>

            <!-- 卡片設定 -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-semibold mb-3 flex items-center gap-2 text-slate-700">
                    <i data-lucide="image" class="w-4 h-4"></i> 卡片設定
                </h3>
                <label class="w-full bg-slate-50 hover:bg-slate-100 text-slate-600 py-3 rounded-lg font-medium border border-slate-200 flex items-center justify-center gap-2 cursor-pointer">
                    <i data-lucide="upload" class="w-4 h-4"></i> 上傳背景圖片
                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                </label>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCT-ZuIDrI66NTZ0ZEipDmpfFxbEZrmGto",
            authDomain: "card-5d320.firebaseapp.com",
            projectId: "card-5d320",
            storageBucket: "card-5d320.firebasestorage.app",
            messagingSenderId: "149511398240",
            appId: "1:149511398240:web:c381f874603c51fb74f405",
            measurementId: "G-5FGC2VMT5J"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const statusEl = document.getElementById('status');
        const stampGrid = document.getElementById('stampGrid');
        
        let stamps = Array(10).fill(false);
        let currentUser = null;

        signInAnonymously(auth).catch(e => statusEl.innerText = "登入失敗: " + e.message);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                statusEl.innerText = "雲端同步中 (已登入)";
                subscribeToData();
            }
        });

        function subscribeToData() {
            const docRef = doc(db, 'reward_cards', 'main_data'); 
            onSnapshot(docRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    stamps = data.stamps || Array(10).fill(false);
                    renderStamps();
                    updateButtonStyles(stamps.length);
                }
            }, (err) => statusEl.innerText = "資料庫錯誤: " + err.message);
        }

        async function saveToCloud() {
            if (!db) return;
            try {
                await setDoc(doc(db, 'reward_cards', 'main_data'), {
                    stamps: stamps,
                    updatedAt: new Date()
                });
            } catch (e) { console.error("Save failed", e); }
        }

        function renderStamps() {
            stampGrid.innerHTML = '';
            // 動態調整格子大小以適應數量
            const sizeClass = stamps.length > 15 ? 'w-10 h-10 md:w-14 md:h-14' : 'w-12 h-12 md:w-16 md:h-16';
            
            stamps.forEach((isTicked, index) => {
                const btn = document.createElement('button');
                btn.className = `${sizeClass} rounded-full border-4 flex items-center justify-center transition-all ${
                    isTicked ? 'bg-white border-green-500 shadow-md' : 'bg-white/80 border-blue-400'
                }`;
                btn.innerHTML = isTicked ? '<i data-lucide="check" class="text-green-600 w-full h-full p-1 stroke-[4] tick-animation"></i>' : '';
                btn.onclick = () => {
                    stamps[index] = !stamps[index];
                    renderStamps();
                    saveToCloud();
                };
                stampGrid.appendChild(btn);
            });
            lucide.createIcons();
        }

        // 供外部按鈕調用的切換數量函數
        window.changeGridSize = (newSize) => {
            if (newSize === stamps.length) return;
            
            if (newSize > stamps.length) {
                // 增加格子
                stamps = [...stamps, ...Array(newSize - stamps.length).fill(false)];
            } else {
                // 減少格子（保留前面的進度）
                stamps = stamps.slice(0, newSize);
            }
            renderStamps();
            saveToCloud();
            updateButtonStyles(newSize);
        };

        function updateButtonStyles(currentSize) {
            document.querySelectorAll('.grid-btn').forEach(btn => {
                if (parseInt(btn.dataset.size) === currentSize) {
                    btn.classList.add('bg-blue-50', 'border-blue-400', 'text-blue-600');
                    btn.classList.remove('bg-white', 'border-slate-200');
                } else {
                    btn.classList.remove('bg-blue-50', 'border-blue-400', 'text-blue-600');
                    btn.classList.add('bg-white', 'border-slate-200');
                }
            });
        }

        document.getElementById('btnRemoveLast').onclick = () => {
            const lastIndex = stamps.lastIndexOf(true);
            if (lastIndex !== -1) {
                stamps[lastIndex] = false;
                renderStamps();
                saveToCloud();
            }
        };

        document.getElementById('imageUpload').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('bgOverlay').style.backgroundImage = `url(${event.target.result})`;
                    document.getElementById('defaultBg').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        };

        renderStamps();
    </script>
</body>
</html>
