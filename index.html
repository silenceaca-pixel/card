<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乜都得卡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .stamp-card { aspect-ratio: 1 / 1.2; min-height: 450px; }
        .tick-animation { animation: zoomIn 0.2s ease-out forwards; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.3); } to { opacity: 1; transform: scale(1); } }
        .tab-active { @apply bg-slate-900 text-white shadow-lg; }
        #bgOverlay { transition: background-image 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 p-4">

    <div class="max-w-2xl mx-auto flex flex-col items-center">
        <!-- 導覽分頁 -->
        <nav class="flex gap-2 mb-6 bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200 w-full max-w-xs">
            <button onclick="switchPage('rain')" id="tab-rain" class="flex-1 py-2 px-4 rounded-xl text-sm font-bold transition-all">Rain</button>
            <button onclick="switchPage('car')" id="tab-car" class="flex-1 py-2 px-4 rounded-xl text-sm font-bold transition-all">Car</button>
        </nav>

        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-slate-900 mb-1" id="pageTitle">Rain's Stamps</h1>
            <p id="status" class="text-slate-400 text-xs">正在連線至雲端...</p>
        </header>

        <!-- 卡片區域 -->
        <div id="cardContainer" class="stamp-card relative w-full bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
            <div id="bgOverlay" class="absolute inset-0 z-0 bg-cover bg-center opacity-90"></div>
            <div id="defaultBg" class="absolute inset-0 z-0 bg-gradient-to-br from-slate-50 to-blue-50 opacity-50"></div>
            
            <div class="absolute inset-0 z-10 p-4 flex flex-col justify-center items-center">
                <div id="stampGrid" class="grid grid-cols-10 gap-1 md:gap-2 w-full max-w-md">
                    <!-- 100 格將由此生成 -->
                </div>
            </div>
        </div>

        <!-- 功能區 -->
        <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <button id="btnRemoveLast" class="w-full bg-yellow-50 hover:bg-yellow-100 text-yellow-700 py-3 rounded-xl font-medium border border-yellow-200 transition-colors">
                    移除最後一個勾
                </button>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <label class="w-full bg-slate-50 hover:bg-slate-100 text-slate-600 py-3 rounded-xl font-medium border border-slate-200 flex items-center justify-center gap-2 cursor-pointer">
                    <i data-lucide="image" class="w-4 h-4"></i> 背景圖片
                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                </label>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCT-ZuIDrI66NTZ0ZEipDmpfFxbEZrmGto",
            authDomain: "card-5d320.firebaseapp.com",
            projectId: "card-5d320",
            storageBucket: "card-5d320.firebasestorage.app",
            messagingSenderId: "149511398240",
            appId: "1:149511398240:web:c381f874603c51fb74f405",
            measurementId: "G-5FGC2VMT5J"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const statusEl = document.getElementById('status');
        const stampGrid = document.getElementById('stampGrid');
        const bgOverlay = document.getElementById('bgOverlay');
        const defaultBg = document.getElementById('defaultBg');
        
        let currentPage = 'rain'; 
        let stamps = Array(100).fill(false);
        let currentBgBase64 = null;
        let unsubscribe = null;

        window.switchPage = (page) => {
            currentPage = page;
            document.getElementById('pageTitle').innerText = (page === 'rain' ? "Rain's Stamps" : "Car's Stamps");
            
            document.getElementById('tab-rain').className = page === 'rain' ? 'flex-1 py-2 px-4 rounded-xl text-sm font-bold tab-active' : 'flex-1 py-2 px-4 rounded-xl text-sm font-bold text-slate-400 hover:text-slate-600';
            document.getElementById('tab-car').className = page === 'car' ? 'flex-1 py-2 px-4 rounded-xl text-sm font-bold tab-active' : 'flex-1 py-2 px-4 rounded-xl text-sm font-bold text-slate-400 hover:text-slate-600';
            
            subscribeToData();
        };

        signInAnonymously(auth).catch(e => statusEl.innerText = "連線失敗: " + e.message);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                statusEl.innerText = "雲端同步中";
                window.switchPage('rain');
            }
        });

        function subscribeToData() {
            if (unsubscribe) unsubscribe();

            const docId = currentPage === 'rain' ? 'rain_data' : 'car_data';
            const docRef = doc(db, 'reward_cards', docId); 
            
            unsubscribe = onSnapshot(docRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    stamps = data.stamps || Array(100).fill(false);
                    currentBgBase64 = data.bgImage || null;
                    
                    if (stamps.length !== 100) {
                        stamps = stamps.slice(0, 100).concat(Array(Math.max(0, 100 - stamps.length)).fill(false));
                    }
                } else {
                    stamps = Array(100).fill(false);
                    currentBgBase64 = null;
                }
                updateUI();
            }, (err) => statusEl.innerText = "錯誤: " + err.message);
        }

        async function saveToCloud() {
            if (!db) return;
            const docId = currentPage === 'rain' ? 'rain_data' : 'car_data';
            try {
                await setDoc(doc(db, 'reward_cards', docId), {
                    stamps: stamps,
                    bgImage: currentBgBase64,
                    updatedAt: new Date()
                }, { merge: true });
            } catch (e) { console.error("Save failed", e); }
        }

        function updateUI() {
            // 更新背景
            if (currentBgBase64) {
                bgOverlay.style.backgroundImage = `url(${currentBgBase64})`;
                defaultBg.classList.add('hidden');
            } else {
                bgOverlay.style.backgroundImage = 'none';
                defaultBg.classList.remove('hidden');
            }
            renderStamps();
        }

        function renderStamps() {
            stampGrid.innerHTML = '';
            stamps.forEach((isTicked, index) => {
                const btn = document.createElement('button');
                btn.className = `aspect-square rounded-full border-[1px] md:border-2 flex items-center justify-center transition-all ${
                    isTicked ? 'bg-green-500 border-green-600 shadow-sm' : 'bg-white/40 border-slate-300'
                }`;
                btn.innerHTML = isTicked ? '<i data-lucide="check" class="text-white w-full h-full p-0.5 tick-animation"></i>' : '';
                btn.onclick = () => {
                    stamps[index] = !stamps[index];
                    saveToCloud();
                };
                stampGrid.appendChild(btn);
            });
            lucide.createIcons();
        }

        document.getElementById('btnRemoveLast').onclick = () => {
            const lastIndex = stamps.lastIndexOf(true);
            if (lastIndex !== -1) {
                stamps[lastIndex] = false;
                saveToCloud();
            }
        };

        document.getElementById('imageUpload').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                // 檢查文件大小（Firestore 文檔限制 1MB，建議壓縮圖片或限制大小）
                if (file.size > 800000) {
                    alert("圖片太大了！請上傳小於 800KB 的圖片以確保順利儲存。");
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    currentBgBase64 = event.target.result;
                    updateUI();
                    saveToCloud();
                };
                reader.readAsDataURL(file);
            }
        };

        renderStamps();
    </script>
</body>
</html>
